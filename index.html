<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cobalt Studio</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body class="editor-expanded">
    <!-- Splash Screen (first load only) -->
    <div id="splash-screen" class="hidden">
        <div class="splash-content">
            <span class="splash-logo-icon"><svg viewBox="0 0 64 64" fill="none"><path d="M33 30L21 9L32 2L58 17L58 30Z" fill="#93c5fd"/><path d="M33 30L58 17L58 30Z" fill="#4338ca"/><path d="M34 34L58 34L58 47L32 62Z" fill="#4338ca"/><path d="M34 34L20 56L32 62Z" fill="#6366f1"/><path d="M30 32L17 11L6 17Z" fill="#93c5fd"/><path d="M30 32L6 17L6 47L17 55Z" fill="#6366f1"/></svg></span>
            <span class="splash-logo-text">Cobalt Studio</span>
            <span class="splash-tagline">Build 3D games with blocks</span>
            <span class="splash-version" id="splash-version"></span>
            <button class="splash-start-btn" id="splash-start">
                <span class="material-icons-round">arrow_forward</span>
                Get Started
            </button>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="hidden">
        <div class="auth-container">
            <div class="auth-brand">
                <span class="auth-logo-icon"><svg viewBox="0 0 64 64" fill="none"><path d="M33 30L21 9L32 2L58 17L58 30Z" fill="#93c5fd"/><path d="M33 30L58 17L58 30Z" fill="#4338ca"/><path d="M34 34L58 34L58 47L32 62Z" fill="#4338ca"/><path d="M34 34L20 56L32 62Z" fill="#6366f1"/><path d="M30 32L17 11L6 17Z" fill="#93c5fd"/><path d="M30 32L6 17L6 47L17 55Z" fill="#6366f1"/></svg></span>
                <span class="auth-logo-text">Cobalt Studio</span>
            </div>
            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab-btn active" data-auth-tab="signup">Sign Up</button>
                    <button class="auth-tab-btn" data-auth-tab="login">Log In</button>
                </div>
                <form class="auth-form active" id="auth-signup-form" autocomplete="off">
                    <div class="auth-field">
                        <label for="auth-signup-username">Username</label>
                        <input type="text" id="auth-signup-username" placeholder="Choose a username" maxlength="20" spellcheck="false" autocomplete="off">
                        <div class="auth-field-hint" id="auth-username-hint"></div>
                    </div>
                    <div class="auth-field">
                        <label for="auth-signup-password">Password</label>
                        <input type="password" id="auth-signup-password" placeholder="Choose a password (4+ characters)" autocomplete="new-password">
                    </div>
                    <div class="auth-field">
                        <label for="auth-signup-confirm">Confirm Password</label>
                        <input type="password" id="auth-signup-confirm" placeholder="Confirm your password" autocomplete="new-password">
                    </div>
                    <div class="auth-field auth-captcha-field">
                        <label id="auth-captcha-label">Loading...</label>
                        <input type="text" id="auth-captcha-answer" placeholder="Type your answer" autocomplete="off" spellcheck="false">
                    </div>
                    <div class="auth-error" id="auth-signup-error"></div>
                    <button type="submit" class="auth-submit-btn" id="auth-signup-btn" disabled>Create Account</button>
                </form>
                <form class="auth-form" id="auth-login-form" autocomplete="off">
                    <div class="auth-field">
                        <label for="auth-login-username">Username</label>
                        <input type="text" id="auth-login-username" placeholder="Your username" spellcheck="false" autocomplete="off">
                    </div>
                    <div class="auth-field">
                        <label for="auth-login-password">Password</label>
                        <input type="password" id="auth-login-password" placeholder="Your password" autocomplete="current-password">
                    </div>
                    <div class="auth-error" id="auth-login-error"></div>
                    <button type="submit" class="auth-submit-btn">Log In</button>
                </form>
                <div class="auth-footer">Free to use — no email required</div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="loading-spinner">
            <span class="material-icons-round loading-icon">hourglass_empty</span>
            <span class="loading-text">Loading project...</span>
        </div>
    </div>

    <!-- Title Screen / Project Browser -->
    <div id="title-screen" class="hidden">
        <div class="title-header" style="justify-content:space-between">
            <div class="title-brand">
                <span class="title-logo-icon"><svg viewBox="0 0 64 64" fill="none"><path d="M33 30L21 9L32 2L58 17L58 30Z" fill="#93c5fd"/><path d="M33 30L58 17L58 30Z" fill="#4338ca"/><path d="M34 34L58 34L58 47L32 62Z" fill="#4338ca"/><path d="M34 34L20 56L32 62Z" fill="#6366f1"/><path d="M30 32L17 11L6 17Z" fill="#93c5fd"/><path d="M30 32L6 17L6 47L17 55Z" fill="#6366f1"/></svg></span>
                <span class="title-logo-text">Cobalt Studio</span>
                <span class="title-tagline">Build 3D games with blocks</span>
            </div>
            <div class="title-user-info" id="title-user-info">
                <div class="title-user-avatar" id="title-user-avatar" title="Change avatar" style="cursor:pointer"></div>
                <span class="title-user-name" id="title-user-name"></span>
                <button class="admin-inbox-btn hidden" id="btn-admin-inbox" title="Report Inbox">
                    <span class="material-icons-round">inbox</span>
                    <span class="admin-inbox-badge hidden" id="admin-inbox-badge">0</span>
                </button>
                <button class="title-signout-btn" id="btn-sign-out">Sign Out</button>
            </div>
        </div>
        <div class="title-content">
            <div class="title-actions">
                <button class="title-new-btn" id="btn-new-project">
                    <span class="material-icons-round">add</span>
                    New Project
                </button>
                <button class="title-import-btn" id="btn-import-project">
                    <span class="material-icons-round">file_upload</span>
                    Import JSON
                </button>
                <button class="title-join-party-btn" id="btn-title-join-party">
                    <span class="material-icons-round">group</span>
                    Join Party
                </button>
            </div>
            <div class="title-tabs">
                <button class="title-tab-btn active" data-title-tab="my-projects">
                    <span class="material-icons-round">folder</span>
                    My Projects
                </button>
                <button class="title-tab-btn" data-title-tab="explore">
                    <span class="material-icons-round">explore</span>
                    Explore
                </button>
                <button class="title-tab-btn" data-title-tab="favorites">
                    <span class="material-icons-round">favorite</span>
                    Favorites
                </button>
            </div>
            <!-- My Projects Tab -->
            <div id="tab-my-projects" class="title-tab-content active">
                <div class="title-search-bar">
                    <span class="material-icons-round">search</span>
                    <input type="text" id="project-search" placeholder="Search projects..." autocomplete="off" spellcheck="false">
                </div>
                <div class="title-section-header">
                    <span>My Projects</span>
                    <span class="project-count" id="project-count">0</span>
                    <div style="margin-left:auto;display:flex;gap:4px">
                        <button class="title-sort-btn active" id="sort-date" title="Sort by Date">
                            <span class="material-icons-round">schedule</span>
                        </button>
                        <button class="title-sort-btn" id="sort-name" title="Sort by Name">
                            <span class="material-icons-round">sort_by_alpha</span>
                        </button>
                    </div>
                </div>
                <div class="project-grid" id="project-grid">
                    <!-- Populated dynamically -->
                </div>
                <div class="title-empty-state" id="title-empty">
                    <span class="material-icons-round">videogame_asset</span>
                    <p>No projects yet</p>
                    <span class="empty-hint">Click "New Project" to get started</span>
                </div>
            </div>
            <!-- Explore Tab -->
            <div id="tab-explore" class="title-tab-content">
                <div class="explore-search-bar">
                    <span class="material-icons-round">search</span>
                    <input type="text" id="explore-search" placeholder="Search community projects..." autocomplete="off" spellcheck="false">
                </div>
                <div class="explore-filter-row">
                    <div class="explore-categories">
                        <button class="explore-cat-btn active" data-explore-cat="all">All</button>
                        <button class="explore-cat-btn" data-explore-cat="games">Games</button>
                        <button class="explore-cat-btn" data-explore-cat="art">Art</button>
                        <button class="explore-cat-btn" data-explore-cat="my-shared">My Shared</button>
                    </div>
                    <div class="explore-sort">
                        <button class="explore-sort-btn active" data-explore-sort="popular">
                            <span class="material-icons-round">trending_up</span>
                            Popular
                        </button>
                        <button class="explore-sort-btn" data-explore-sort="newest">
                            <span class="material-icons-round">schedule</span>
                            Newest
                        </button>
                    </div>
                </div>
                <div id="explore-trending-section" style="display:none">
                    <div class="explore-section-header trending-header">
                        <span class="material-icons-round">local_fire_department</span>
                        <span>Trending Now</span>
                    </div>
                    <div class="explore-trending-wrapper">
                        <button class="trending-arrow trending-arrow-left" id="trending-arrow-left"><span class="material-icons-round">chevron_left</span></button>
                        <div class="explore-trending-row" id="explore-trending-grid"></div>
                        <button class="trending-arrow trending-arrow-right" id="trending-arrow-right"><span class="material-icons-round">chevron_right</span></button>
                    </div>
                </div>
                <div id="explore-community-section">
                    <div class="explore-section-header">
                        <span class="material-icons-round">people</span>
                        <span>Community Projects</span>
                    </div>
                    <div class="explore-grid" id="explore-community-grid"></div>
                </div>
                <div class="explore-empty" id="explore-empty" style="display:none">
                    <span class="material-icons-round">explore_off</span>
                    <p>No projects found</p>
                </div>
            </div>
            <!-- Favorites Tab -->
            <div id="tab-favorites" class="title-tab-content">
                <div class="explore-section-header">
                    <span class="material-icons-round">favorite</span>
                    <span>My Favorites</span>
                </div>
                <div class="explore-grid" id="favorites-grid"></div>
                <div class="explore-empty" id="favorites-empty" style="display:none">
                    <span class="material-icons-round">favorite_border</span>
                    <p>No favorites yet</p>
                    <span class="empty-hint">Favorite projects from the Explore tab to see them here</span>
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="new-project-modal" class="hidden">
        <div class="new-project-dialog">
            <div class="new-project-dialog-header">
                <span class="material-icons-round">rocket_launch</span>
                <h3>Create New Project</h3>
            </div>
            <div class="new-project-dialog-body">
                <label for="new-project-name">Project Name</label>
                <input type="text" id="new-project-name" class="project-name-input" placeholder="My Awesome Game" maxlength="60" autocomplete="off" spellcheck="false">
                <div class="new-project-templates">
                    <label>Start From</label>
                    <div class="template-options">
                        <div class="template-option selected" data-template="empty">
                            <span class="material-icons-round">check_box_outline_blank</span>
                            <span>Empty</span>
                        </div>
                        <div class="template-option" data-template="flat-arena">
                            <span class="material-icons-round">sports_mma</span>
                            <span>Arena</span>
                        </div>
                        <div class="template-option" data-template="platformer">
                            <span class="material-icons-round">layers</span>
                            <span>Platformer</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="new-project-dialog-footer">
                <button class="new-project-cancel-btn" id="new-project-cancel">Cancel</button>
                <button class="new-project-create-btn" id="new-project-create">
                    <span class="material-icons-round">arrow_forward</span>
                    Create
                </button>
            </div>
        </div>
    </div>

    <!-- Top Toolbar -->
    <div id="toolbar">
        <div class="toolbar-left">
            <div class="logo">
                <span class="logo-icon"><svg viewBox="0 0 64 64" fill="none"><path d="M33 30L21 9L32 2L58 17L58 30Z" fill="#93c5fd"/><path d="M33 30L58 17L58 30Z" fill="#4338ca"/><path d="M34 34L58 34L58 47L32 62Z" fill="#4338ca"/><path d="M34 34L20 56L32 62Z" fill="#6366f1"/><path d="M30 32L17 11L6 17Z" fill="#93c5fd"/><path d="M30 32L6 17L6 47L17 55Z" fill="#6366f1"/></svg></span>
                <span class="logo-text">Cobalt Studio</span>
            </div>
            <div class="toolbar-project-name hidden" id="toolbar-project-name">
                <span class="project-name-text" id="toolbar-project-text"></span>
                <span class="unsaved-dot hidden" id="unsaved-dot"></span>
            </div>
            <button class="tool-btn" id="btn-back-home" title="My Projects">
                <span class="material-icons-round">home</span>
            </button>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group toolbar-3d-tools" id="toolbar-3d-tools">
                <button class="tool-btn" id="btn-select" title="Select (V)" data-tool="select">
                    <span class="material-icons-round">near_me</span>
                </button>
                <button class="tool-btn" id="btn-move" title="Move (G)" data-tool="move">
                    <span class="material-icons-round">open_with</span>
                </button>
                <button class="tool-btn" id="btn-rotate" title="Rotate (R)" data-tool="rotate">
                    <span class="material-icons-round">rotate_right</span>
                </button>
                <button class="tool-btn" id="btn-scale" title="Scale (S)" data-tool="scale">
                    <span class="material-icons-round">aspect_ratio</span>
                </button>
                <div class="rotate-angle-group" id="rotate-angle-group">
                    <select id="rotate-axis" title="Rotation Axis">
                        <option value="y" selected>Y</option>
                        <option value="x">X</option>
                        <option value="z">Z</option>
                    </select>
                    <input type="number" id="rotate-angle" placeholder="45" step="1" title="Rotation Angle">
                    <span class="angle-unit">°</span>
                </div>
            </div>
            <div class="toolbar-divider toolbar-3d-tools"></div>
            <div class="toolbar-group toolbar-3d-tools">
                <button class="tool-btn" id="btn-snap" title="Toggle Snap">
                    <span class="material-icons-round">grid_on</span>
                </button>
                <select id="snap-size" title="Snap Size">
                    <option value="0.25">0.25</option>
                    <option value="0.5" selected>0.5</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                </select>
            </div>
        </div>
        <div class="toolbar-center">
            <button class="play-btn" id="btn-play" title="Play (F5)">
                <span class="material-icons-round">play_arrow</span>
                <span>Play</span>
            </button>
            <button class="play-btn stop hidden" id="btn-stop" title="Stop (F5)">
                <span class="material-icons-round">stop</span>
                <span>Stop</span>
            </button>
        </div>
        <div class="toolbar-right">
            <div class="toolbar-user" id="toolbar-user">
                <div class="toolbar-user-avatar" id="toolbar-user-avatar"></div>
            </div>
            <button class="tool-btn" id="btn-ai-assistant" title="AI Build Assistant">
                <span class="material-icons-round">auto_awesome</span>
            </button>
            <button class="tool-btn" id="btn-party" title="Multiplayer Party">
                <span class="material-icons-round">group</span>
            </button>
            <button class="tool-btn" id="btn-templates" title="Map Templates">
                <span class="material-icons-round">dashboard</span>
            </button>
            <button class="tool-btn" id="btn-save" title="Save Project">
                <span class="material-icons-round">save</span>
            </button>
            <button class="tool-btn" id="btn-load" title="Load Project">
                <span class="material-icons-round">folder_open</span>
            </button>
            <button class="tool-btn" id="btn-export" title="Export Game">
                <span class="material-icons-round">publish</span>
            </button>
            <button class="tool-btn" id="btn-share" title="Share Project">
                <span class="material-icons-round">share</span>
            </button>
            <button class="tool-btn" id="btn-settings" title="Game Settings">
                <span class="material-icons-round">settings</span>
            </button>
            <button class="tool-btn" id="btn-tutorial" title="Tutorials">
                <span class="material-icons-round">school</span>
            </button>
            <div class="toolbar-divider"></div>
            <button class="tool-btn" id="btn-undo" title="Undo (Ctrl+Z)">
                <span class="material-icons-round">undo</span>
            </button>
            <button class="tool-btn" id="btn-redo" title="Redo (Ctrl+Y)">
                <span class="material-icons-round">redo</span>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-content">
        <!-- Left Panel - Explorer & Object Library -->
        <div id="left-panel" class="panel">
            <div class="panel-tabs">
                <button class="panel-tab active" data-tab="explorer">Explorer</button>
                <button class="panel-tab" data-tab="library">Toolbox</button>
                <button class="panel-tab" data-tab="terrain">Terrain</button>
            </div>

            <!-- Explorer Tab -->
            <div class="tab-content active" id="tab-explorer">
                <div class="panel-section">
                    <div class="section-header">
                        <span>World Objects</span>
                        <button class="small-btn" id="btn-add-folder" title="New Folder">
                            <span class="material-icons-round">create_new_folder</span>
                        </button>
                    </div>
                    <div id="object-tree" class="tree-view">
                        <div class="tree-item root">
                            <span class="material-icons-round tree-icon">public</span>
                            <span>Workspace</span>
                        </div>
                        <div id="tree-children" class="tree-children">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toolbox Tab -->
            <div class="tab-content" id="tab-library">
                <div class="panel-section">
                    <div class="section-header"><span>Primitives</span></div>
                    <div class="object-grid">
                        <button class="object-btn" data-shape="box" title="Box">
                            <div class="shape-preview box-preview"></div>
                            <span>Box</span>
                        </button>
                        <button class="object-btn" data-shape="sphere" title="Sphere">
                            <div class="shape-preview sphere-preview"></div>
                            <span>Sphere</span>
                        </button>
                        <button class="object-btn" data-shape="cylinder" title="Cylinder">
                            <div class="shape-preview cylinder-preview"></div>
                            <span>Cylinder</span>
                        </button>
                        <button class="object-btn" data-shape="cone" title="Cone">
                            <div class="shape-preview cone-preview"></div>
                            <span>Cone</span>
                        </button>
                        <button class="object-btn" data-shape="plane" title="Plane">
                            <div class="shape-preview plane-preview"></div>
                            <span>Plane</span>
                        </button>
                        <button class="object-btn" data-shape="torus" title="Torus">
                            <div class="shape-preview torus-preview"></div>
                            <span>Torus</span>
                        </button>
                        <button class="object-btn" data-shape="wedge" title="Wedge/Ramp">
                            <div class="shape-preview wedge-preview"></div>
                            <span>Wedge</span>
                        </button>
                        <button class="object-btn" data-shape="stairs" title="Stairs">
                            <div class="shape-preview stairs-preview"></div>
                            <span>Stairs</span>
                        </button>
                        <button class="object-btn" data-shape="pyramid" title="Pyramid">
                            <div class="shape-preview pyramid-preview"></div>
                            <span>Pyramid</span>
                        </button>
                        <button class="object-btn" data-shape="dome" title="Dome">
                            <div class="shape-preview dome-preview"></div>
                            <span>Dome</span>
                        </button>
                        <button class="object-btn" data-shape="arch" title="Arch">
                            <div class="shape-preview arch-preview"></div>
                            <span>Arch</span>
                        </button>
                        <button class="object-btn" data-shape="tube" title="Tube/Pipe">
                            <div class="shape-preview tube-preview"></div>
                            <span>Tube</span>
                        </button>
                        <button class="object-btn" data-shape="wall" title="Wall">
                            <div class="shape-preview wall-preview"></div>
                            <span>Wall</span>
                        </button>
                        <button class="object-btn" data-shape="corner" title="Corner Wall">
                            <div class="shape-preview corner-preview"></div>
                            <span>Corner</span>
                        </button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="section-header"><span>Prefabs</span></div>
                    <div class="object-grid">
                        <button class="object-btn" data-prefab="spawn" title="Spawn Point">
                            <div class="shape-preview spawn-preview"></div>
                            <span>Spawn</span>
                        </button>
                        <button class="object-btn" data-prefab="light-point" title="Point Light">
                            <div class="shape-preview light-preview"></div>
                            <span>Light</span>
                        </button>
                        <button class="object-btn" data-prefab="coin" title="Collectible Coin">
                            <div class="shape-preview coin-preview"></div>
                            <span>Coin</span>
                        </button>
                        <button class="object-btn" data-prefab="npc" title="NPC Character">
                            <div class="shape-preview npc-preview"></div>
                            <span>NPC</span>
                        </button>
                        <button class="object-btn" data-prefab="tree" title="Simple Tree">
                            <div class="shape-preview tree-preview"></div>
                            <span>Tree</span>
                        </button>
                        <button class="object-btn" data-prefab="house" title="Simple House">
                            <div class="shape-preview house-preview"></div>
                            <span>House</span>
                        </button>
                        <button class="object-btn" data-prefab="platform" title="Floating Platform">
                            <div class="shape-preview platform-preview"></div>
                            <span>Platform</span>
                        </button>
                        <button class="object-btn" data-prefab="bridge" title="Bridge">
                            <div class="shape-preview bridge-preview"></div>
                            <span>Bridge</span>
                        </button>
                        <button class="object-btn" data-prefab="crate" title="Crate">
                            <div class="shape-preview crate-preview"></div>
                            <span>Crate</span>
                        </button>
                        <button class="object-btn" data-prefab="gem" title="Gem Pickup">
                            <div class="shape-preview gem-preview"></div>
                            <span>Gem</span>
                        </button>
                        <button class="object-btn" data-prefab="camera" title="Camera View">
                            <div class="shape-preview camera-preview"></div>
                            <span>Camera</span>
                        </button>
                    </div>
                </div>
                <div class="panel-section" id="custom-objects-section">
                    <div class="section-header">
                        <span>My Objects</span>
                        <button class="small-btn" id="btn-create-object" title="Create Custom Object">
                            <span class="material-icons-round">add_circle</span>
                        </button>
                    </div>
                    <div class="object-grid" id="custom-objects-grid">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div class="panel-section" id="ui-screens-section">
                    <div class="section-header">
                        <span>UI Screens</span>
                        <button class="small-btn" id="btn-create-screen" title="Create UI Screen">
                            <span class="material-icons-round">add_circle</span>
                        </button>
                    </div>
                    <div class="object-grid" id="ui-screens-grid">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Terrain Tab -->
            <div class="tab-content" id="tab-terrain">
                <div class="panel-section">
                    <div class="section-header"><span>Terrain Tools</span></div>
                    <div class="terrain-tools">
                        <button class="object-btn" data-terrain="flat" title="Flat Ground">
                            <span class="material-icons-round">square</span>
                            <span>Flat</span>
                        </button>
                        <button class="object-btn" data-terrain="raise" title="Raise Terrain">
                            <span class="material-icons-round">landscape</span>
                            <span>Raise</span>
                        </button>
                        <button class="object-btn" data-terrain="water" title="Add Water">
                            <span class="material-icons-round">water</span>
                            <span>Water</span>
                        </button>
                        <button class="object-btn" data-terrain="paint" title="Paint Terrain">
                            <span class="material-icons-round">brush</span>
                            <span>Paint</span>
                        </button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="section-header"><span>Terrain Materials</span></div>
                    <div class="material-swatches">
                        <button class="swatch" data-material="grass" style="background:#4a7c3f" title="Grass"></button>
                        <button class="swatch" data-material="dirt" style="background:#8B7355" title="Dirt"></button>
                        <button class="swatch" data-material="sand" style="background:#C2B280" title="Sand"></button>
                        <button class="swatch" data-material="stone" style="background:#808080" title="Stone"></button>
                        <button class="swatch" data-material="snow" style="background:#FFFAFA" title="Snow"></button>
                        <button class="swatch" data-material="lava" style="background:#CF1020" title="Lava"></button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="section-header"><span>Environment</span></div>
                    <div class="env-controls">
                        <label>Sky Color
                            <input type="color" id="sky-color" value="#87CEEB">
                        </label>
                        <label>Skybox
                            <select id="skybox-type" class="prop-input">
                                <option value="default">Default</option>
                                <option value="gradient">Gradient Sky</option>
                                <option value="sunset">Sunset</option>
                                <option value="night">Starry Night</option>
                                <option value="cloudy">Cloudy</option>
                            </select>
                        </label>
                        <label>Ambient Light
                            <input type="range" id="ambient-light" min="0" max="100" value="60">
                        </label>
                        <label>Fog Density
                            <input type="range" id="fog-density" min="0" max="100" value="0">
                        </label>
                        <label>Weather
                            <select id="weather-type" class="prop-input">
                                <option value="none">None</option>
                                <option value="rain">Rain</option>
                                <option value="snow">Snow</option>
                                <option value="fireflies">Fireflies</option>
                            </select>
                        </label>
                        <label>Background Music
                            <select id="bg-music" class="prop-input">
                                <option value="none">None</option>
                                <option value="adventure">Adventure</option>
                                <option value="chill">Chill</option>
                                <option value="action">Action</option>
                                <option value="mystery">Mystery</option>
                                <option value="retro">Retro</option>
                            </select>
                        </label>
                        <label>Music Volume
                            <input type="range" id="music-volume" min="0" max="100" value="30">
                        </label>
                        <label>
                            <input type="checkbox" id="shadows-enabled" checked> Shadows
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3D Viewport -->
        <div id="viewport-container">
            <canvas id="viewport"></canvas>
            <div id="viewport-overlay">
                <div class="viewport-info" id="viewport-info">
                    <span id="info-fps">60 FPS</span>
                    <span id="info-objects">0 objects</span>
                    <button class="viewport-fullscreen-btn" id="btn-fullscreen-viewport" title="Fullscreen Viewport">
                        <span class="material-icons-round">fullscreen</span>
                    </button>
                </div>
                <div class="viewport-gizmo" id="viewport-gizmo">
                    <!-- Camera orientation gizmo -->
                </div>
                <div class="collab-presence-bar hidden" id="collab-presence-bar">
                    <!-- Populated dynamically -->
                </div>
            </div>
            <!-- Play mode overlay -->
            <div id="play-overlay" class="hidden">
                <div class="play-hud">
                    <div class="play-info">
                        <span>WASD to move | Arrows to look | Space to jump | ESC to stop</span>
                    </div>
                    <div class="game-hud" id="game-hud">
                        <!-- Dynamic HUD elements -->
                    </div>
                </div>
            </div>
            <!-- Custom game crosshair (follows mouse) -->
            <div id="game-crosshair" class="hidden">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <line x1="12" y1="4" x2="12" y2="10" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <line x1="12" y1="14" x2="12" y2="20" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <line x1="4" y1="12" x2="10" y2="12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <line x1="14" y1="12" x2="20" y2="12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="12" cy="12" r="2" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
                </svg>
            </div>
        </div>

        <!-- Right Panel - Properties -->
        <div id="right-panel" class="panel">
            <div class="panel-tabs">
                <button class="panel-tab active" data-tab="properties">Properties</button>
                <button class="panel-tab" data-tab="materials">Material</button>
            </div>

            <!-- Properties Tab -->
            <div class="tab-content active" id="tab-properties">
                <div id="no-selection" class="empty-state">
                    <span class="material-icons-round">touch_app</span>
                    <p>Select an object to edit its properties</p>
                </div>
                <div id="properties-content" class="hidden">
                    <div class="panel-section">
                        <div class="section-header"><span>Identity</span></div>
                        <div class="prop-row">
                            <label>Name</label>
                            <input type="text" id="prop-name" class="prop-input">
                        </div>
                        <div class="prop-row">
                            <label>Visible</label>
                            <input type="checkbox" id="prop-visible" checked>
                        </div>
                        <div class="prop-row">
                            <label>Locked</label>
                            <input type="checkbox" id="prop-locked">
                        </div>
                    </div>
                    <div class="panel-section">
                        <div class="section-header"><span>Transform</span></div>
                        <div class="prop-row triple">
                            <label>Position</label>
                            <div class="xyz-inputs">
                                <div class="xyz-field x">
                                    <span>X</span>
                                    <input type="number" id="prop-pos-x" step="0.1" class="prop-input">
                                </div>
                                <div class="xyz-field y">
                                    <span>Y</span>
                                    <input type="number" id="prop-pos-y" step="0.1" class="prop-input">
                                </div>
                                <div class="xyz-field z">
                                    <span>Z</span>
                                    <input type="number" id="prop-pos-z" step="0.1" class="prop-input">
                                </div>
                            </div>
                        </div>
                        <div class="prop-row triple">
                            <label>Rotation</label>
                            <div class="xyz-inputs">
                                <div class="xyz-field x">
                                    <span>X</span>
                                    <input type="number" id="prop-rot-x" step="1" class="prop-input">
                                </div>
                                <div class="xyz-field y">
                                    <span>Y</span>
                                    <input type="number" id="prop-rot-y" step="1" class="prop-input">
                                </div>
                                <div class="xyz-field z">
                                    <span>Z</span>
                                    <input type="number" id="prop-rot-z" step="1" class="prop-input">
                                </div>
                            </div>
                        </div>
                        <div class="prop-row triple">
                            <label>Scale</label>
                            <div class="xyz-inputs">
                                <div class="xyz-field x">
                                    <span>X</span>
                                    <input type="number" id="prop-scale-x" step="0.1" class="prop-input">
                                </div>
                                <div class="xyz-field y">
                                    <span>Y</span>
                                    <input type="number" id="prop-scale-y" step="0.1" class="prop-input">
                                </div>
                                <div class="xyz-field z">
                                    <span>Z</span>
                                    <input type="number" id="prop-scale-z" step="0.1" class="prop-input">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section">
                        <div class="section-header"><span>Physics</span></div>
                        <div class="prop-row">
                            <label>Anchored</label>
                            <input type="checkbox" id="prop-anchored" checked>
                        </div>
                        <div class="prop-row">
                            <label>Collidable</label>
                            <input type="checkbox" id="prop-collidable" checked>
                        </div>
                        <div class="prop-row">
                            <label>Mass</label>
                            <input type="number" id="prop-mass" step="0.1" value="1" class="prop-input">
                        </div>
                    </div>
                    <div class="panel-section">
                        <div class="section-header"><span>Actions</span></div>
                        <div class="action-buttons">
                            <button class="action-btn" id="btn-duplicate">
                                <span class="material-icons-round">content_copy</span> Duplicate
                            </button>
                            <button class="action-btn danger" id="btn-delete">
                                <span class="material-icons-round">delete</span> Delete
                            </button>
                            <button class="action-btn primary" id="btn-edit-script">
                                <span class="material-icons-round">code</span> Edit Script
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Material Tab -->
            <div class="tab-content" id="tab-materials">
                <div id="material-no-selection" class="empty-state">
                    <span class="material-icons-round">palette</span>
                    <p>Select an object to edit its material</p>
                </div>
                <div id="material-content" class="hidden">
                    <div class="panel-section">
                        <div class="section-header"><span>Color</span></div>
                        <div class="prop-row">
                            <label>Color</label>
                            <input type="color" id="prop-color" value="#4a90d9" class="color-picker">
                        </div>
                        <div class="color-presets">
                            <button class="swatch" style="background:#e74c3c" data-color="#e74c3c"></button>
                            <button class="swatch" style="background:#e67e22" data-color="#e67e22"></button>
                            <button class="swatch" style="background:#f1c40f" data-color="#f1c40f"></button>
                            <button class="swatch" style="background:#2ecc71" data-color="#2ecc71"></button>
                            <button class="swatch" style="background:#3498db" data-color="#3498db"></button>
                            <button class="swatch" style="background:#9b59b6" data-color="#9b59b6"></button>
                            <button class="swatch" style="background:#1abc9c" data-color="#1abc9c"></button>
                            <button class="swatch" style="background:#ecf0f1" data-color="#ecf0f1"></button>
                            <button class="swatch" style="background:#95a5a6" data-color="#95a5a6"></button>
                            <button class="swatch" style="background:#34495e" data-color="#34495e"></button>
                            <button class="swatch" style="background:#2c3e50" data-color="#2c3e50"></button>
                            <button class="swatch" style="background:#ffffff" data-color="#ffffff"></button>
                        </div>
                    </div>
                    <div class="panel-section" id="texture-section">
                        <div class="section-header"><span>Texture</span></div>
                        <div id="texture-swatches" class="texture-swatches">
                            <!-- Populated dynamically by app.js -->
                        </div>
                        <div class="prop-row hidden" id="tile-scale-row">
                            <label>Tile Scale</label>
                            <input type="range" id="prop-tile-scale" min="1" max="8" value="1" step="1">
                            <span id="tile-scale-value" class="tile-scale-value">1</span>
                        </div>
                    </div>
                    <div class="panel-section">
                        <div class="section-header"><span>Surface</span></div>
                        <div class="prop-row">
                            <label>Material</label>
                            <select id="prop-material-type" class="prop-input">
                                <option value="standard">Standard</option>
                                <option value="metallic">Metallic</option>
                                <option value="glass">Glass</option>
                                <option value="emissive">Glowing</option>
                                <option value="flat">Flat/Unlit</option>
                            </select>
                        </div>
                        <div class="prop-row">
                            <label>Roughness</label>
                            <input type="range" id="prop-roughness" min="0" max="100" value="50">
                        </div>
                        <div class="prop-row">
                            <label>Metalness</label>
                            <input type="range" id="prop-metalness" min="0" max="100" value="0">
                        </div>
                        <div class="prop-row">
                            <label>Opacity</label>
                            <input type="range" id="prop-opacity" min="0" max="100" value="100">
                        </div>
                    </div>
                    <div class="panel-section hidden" id="npc-colors-section">
                        <div class="section-header"><span>Character Parts</span></div>
                        <div class="prop-row">
                            <label>Body</label>
                            <input type="color" id="prop-npc-body" value="#3498db" class="color-picker">
                        </div>
                        <div class="prop-row">
                            <label>Head</label>
                            <input type="color" id="prop-npc-head" value="#f5cba7" class="color-picker">
                        </div>
                        <div class="prop-row">
                            <label>Legs</label>
                            <input type="color" id="prop-npc-legs" value="#2c3e50" class="color-picker">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block Code Editor Panel (Bottom) -->
    <div id="block-editor" class="expanded">
        <div id="block-editor-header">
            <div class="block-editor-title">
                <span class="material-icons-round">code</span>
                <span>Block Code Editor</span>
                <span class="script-target" id="script-target-name">No object selected</span>
            </div>
            <div class="block-editor-controls">
                <button class="tool-btn" id="btn-clear-script" title="Clear Script">
                    <span class="material-icons-round">delete_sweep</span>
                </button>
                <button class="tool-btn" id="btn-fullscreen-editor" title="Fullscreen Editor">
                    <span class="material-icons-round">fullscreen</span>
                </button>
                <button class="tool-btn" id="btn-toggle-editor" title="Toggle Editor">
                    <span class="material-icons-round">expand_more</span>
                </button>
            </div>
        </div>
        <div id="block-editor-body">
            <!-- Block Palette -->
            <div id="block-palette">
                <div class="palette-category active" data-category="events">
                    <span class="cat-color" style="background:#FFD500"></span>
                    Events
                </div>
                <div class="palette-category" data-category="motion">
                    <span class="cat-color" style="background:#4C97FF"></span>
                    Motion
                </div>
                <div class="palette-category" data-category="control">
                    <span class="cat-color" style="background:#FFAB19"></span>
                    Control
                </div>
                <div class="palette-category" data-category="looks">
                    <span class="cat-color" style="background:#9966FF"></span>
                    Looks
                </div>
                <div class="palette-category palette-3d-only" data-category="physics">
                    <span class="cat-color" style="background:#59C059"></span>
                    Physics
                </div>
                <div class="palette-category" data-category="sensing">
                    <span class="cat-color" style="background:#5CB1D6"></span>
                    Sensing
                </div>
                <div class="palette-category" data-category="sound">
                    <span class="cat-color" style="background:#CF63CF"></span>
                    Sound
                </div>
                <div class="palette-category" data-category="variables">
                    <span class="cat-color" style="background:#FF8C1A"></span>
                    Variables
                </div>
                <div class="palette-category palette-2d-only" data-category="pen">
                    <span class="cat-color" style="background:#0fBD8C"></span>
                    Pen
                </div>
                <div class="palette-category palette-3d-only" data-category="shooting">
                    <span class="cat-color" style="background:#E03030"></span>
                    Shooting
                </div>
                <div class="palette-category palette-3d-only" data-category="enemies">
                    <span class="cat-color" style="background:#CC3333"></span>
                    Enemies
                </div>
                <div class="palette-category palette-3d-only" data-category="items">
                    <span class="cat-color" style="background:#44BB44"></span>
                    Items
                </div>
                <div class="palette-category palette-3d-only" data-category="effects">
                    <span class="cat-color" style="background:#E67E22"></span>
                    Effects
                </div>
                <div class="palette-category palette-3d-only" data-category="camera">
                    <span class="cat-color" style="background:#8E44AD"></span>
                    Camera
                </div>
                <div class="palette-category palette-3d-only" data-category="ui">
                    <span class="cat-color" style="background:#E91E63"></span>
                    UI
                </div>
            </div>

            <!-- Block Drawer (blocks for selected category) -->
            <div id="block-drawer">
                <!-- Populated dynamically -->
            </div>

            <!-- Script Area (workspace + backpack) -->
            <div id="script-area">
                <div id="script-workspace">
                    <div id="workspace-canvas">
                        <!-- Block scripts rendered here -->
                    </div>
                </div>
                <!-- Backpack Tray -->
                <div id="backpack-tray" class="backpack-collapsed">
                    <div id="backpack-header">
                        <span class="material-icons-round">backpack</span>
                        <span>Backpack</span>
                        <span id="backpack-count"></span>
                        <span class="material-icons-round backpack-toggle-icon">expand_less</span>
                    </div>
                    <div id="backpack-content">
                        <div id="backpack-items"></div>
                        <div id="backpack-empty">Drag scripts here to save them</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar">
        <span id="status-text">Ready</span>
        <span id="status-autosave" class="status-autosave"></span>
        <span id="status-pos">X: 0 Y: 0 Z: 0</span>
        <span id="status-mode">Edit Mode</span>
        <span id="status-version" class="status-version"></span>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="hidden">
        <div class="context-item" data-action="duplicate">
            <span class="material-icons-round">content_copy</span> Duplicate
        </div>
        <div class="context-item" data-action="delete">
            <span class="material-icons-round">delete</span> Delete
        </div>
        <div class="context-divider"></div>
        <div class="context-item" data-action="group">
            <span class="material-icons-round">folder</span> Group
        </div>
        <div class="context-item" data-action="ungroup">
            <span class="material-icons-round">folder_open</span> Ungroup
        </div>
        <div class="context-divider"></div>
        <div class="context-item" data-action="edit-script">
            <span class="material-icons-round">code</span> Edit Script
        </div>
        <div class="context-item" data-action="properties">
            <span class="material-icons-round">tune</span> Properties
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="material-icons-round">settings</span>
                <span>Game Settings</span>
                <button class="modal-close" id="settings-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-section-title">Controls</div>
                    <div class="control-schemes">
                        <label class="control-scheme selected" data-scheme="first-person">
                            <input type="radio" name="control-scheme" value="first-person" checked>
                            <div class="scheme-card">
                                <span class="material-icons-round scheme-icon">videogame_asset</span>
                                <div class="scheme-info">
                                    <div class="scheme-name">First Person</div>
                                    <div class="scheme-desc">WASD to move, arrows to look. Click to interact with objects.</div>
                                </div>
                                <div class="scheme-keys">WASD + Arrows</div>
                            </div>
                        </label>
                        <label class="control-scheme" data-scheme="third-person">
                            <input type="radio" name="control-scheme" value="third-person">
                            <div class="scheme-card">
                                <span class="material-icons-round scheme-icon">person</span>
                                <div class="scheme-info">
                                    <div class="scheme-name">Third Person</div>
                                    <div class="scheme-desc">Camera orbits behind player. Arrows to orbit, click to interact.</div>
                                </div>
                                <div class="scheme-keys">WASD + Arrows</div>
                            </div>
                        </label>
                        <label class="control-scheme" data-scheme="top-down">
                            <input type="radio" name="control-scheme" value="top-down">
                            <div class="scheme-card">
                                <span class="material-icons-round scheme-icon">grid_view</span>
                                <div class="scheme-info">
                                    <div class="scheme-name">Top Down</div>
                                    <div class="scheme-desc">Overhead camera view. WASD to move. Click to interact.</div>
                                </div>
                                <div class="scheme-keys">WASD + Click</div>
                            </div>
                        </label>
                        <label class="control-scheme" data-scheme="point-click">
                            <input type="radio" name="control-scheme" value="point-click">
                            <div class="scheme-card">
                                <span class="material-icons-round scheme-icon">mouse</span>
                                <div class="scheme-info">
                                    <div class="scheme-name">Point & Click</div>
                                    <div class="scheme-desc">Click ground to move. Click objects to interact.</div>
                                </div>
                                <div class="scheme-keys">Click</div>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">Graphics</div>
                    <div class="settings-row">
                        <label>Quality</label>
                        <select class="prop-input" id="setting-graphics-quality">
                            <option value="ultra">Ultra</option>
                            <option value="high" selected>High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <span class="setting-desc" id="graphics-quality-desc">Balanced quality and performance</span>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">Editor</div>
                    <div class="settings-row">
                        <label>Mouse Orbit</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-mouse-orbit">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="setting-desc">ON: drag to orbit camera &bull; OFF: drag to box-select objects</span>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">Key Bindings</div>
                    <div class="settings-row">
                        <label>Move Forward</label>
                        <select class="prop-input key-bind-select" id="bind-moveForward" data-action="moveForward"></select>
                    </div>
                    <div class="settings-row">
                        <label>Move Back</label>
                        <select class="prop-input key-bind-select" id="bind-moveBack" data-action="moveBack"></select>
                    </div>
                    <div class="settings-row">
                        <label>Move Left</label>
                        <select class="prop-input key-bind-select" id="bind-moveLeft" data-action="moveLeft"></select>
                    </div>
                    <div class="settings-row">
                        <label>Move Right</label>
                        <select class="prop-input key-bind-select" id="bind-moveRight" data-action="moveRight"></select>
                    </div>
                    <div class="settings-row">
                        <label>Look Up</label>
                        <select class="prop-input key-bind-select" id="bind-lookUp" data-action="lookUp"></select>
                    </div>
                    <div class="settings-row">
                        <label>Look Down</label>
                        <select class="prop-input key-bind-select" id="bind-lookDown" data-action="lookDown"></select>
                    </div>
                    <div class="settings-row">
                        <label>Look Left</label>
                        <select class="prop-input key-bind-select" id="bind-lookLeft" data-action="lookLeft"></select>
                    </div>
                    <div class="settings-row">
                        <label>Look Right</label>
                        <select class="prop-input key-bind-select" id="bind-lookRight" data-action="lookRight"></select>
                    </div>
                    <div class="settings-row">
                        <label>Jump</label>
                        <select class="prop-input key-bind-select" id="bind-jump" data-action="jump"></select>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">Player</div>
                    <div class="settings-row">
                        <label>Move Speed</label>
                        <input type="range" id="setting-speed" min="1" max="20" value="6">
                        <span class="setting-value" id="setting-speed-val">6</span>
                    </div>
                    <div class="settings-row">
                        <label>Jump Force</label>
                        <input type="range" id="setting-jump" min="1" max="20" value="8">
                        <span class="setting-value" id="setting-jump-val">8</span>
                    </div>
                    <div class="settings-row">
                        <label>Look Speed</label>
                        <input type="range" id="setting-sensitivity" min="1" max="10" value="5">
                        <span class="setting-value" id="setting-sensitivity-val">5</span>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">Character Appearance</div>
                    <div class="settings-row">
                        <label>Body Color</label>
                        <input type="color" id="setting-player-body" value="#4c97ff">
                    </div>
                    <div class="settings-row">
                        <label>Head Color</label>
                        <input type="color" id="setting-player-head" value="#f5cba7">
                    </div>
                    <div class="settings-row">
                        <label>Detail Color</label>
                        <input type="color" id="setting-player-detail" value="#e0b090">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:600px">
            <div class="modal-header">
                <span class="material-icons-round">school</span>
                <span id="tutorial-header-title">Tutorials</span>
                <button class="modal-close" id="tutorial-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" id="tutorial-body">
                <!-- Steps populated dynamically -->
            </div>
            <div class="modal-footer" id="tutorial-footer" style="display:flex;justify-content:space-between;padding:16px 24px;border-top:1px solid var(--border)">
                <button class="action-btn" id="tutorial-prev" style="display:none">
                    <span class="material-icons-round">arrow_back</span> Previous
                </button>
                <div style="display:flex;gap:8px;align-items:center">
                    <span id="tutorial-step-indicator" style="color:var(--text-dim);font-size:12px"></span>
                </div>
                <button class="action-btn primary" id="tutorial-next">
                    Next <span class="material-icons-round">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templates-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:680px">
            <div class="modal-header">
                <span class="material-icons-round">dashboard</span>
                <span>Map Templates</span>
                <button class="modal-close" id="templates-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="color:var(--text-dim);font-size:12px;margin-bottom:16px">Choose a template to start building from. This will replace your current scene.</p>
                <div class="template-grid" id="template-grid">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Object Builder Modal -->
    <div id="object-builder-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:500px">
            <div class="modal-header">
                <span class="material-icons-round">widgets</span>
                <span>Custom Object Builder</span>
                <button class="modal-close" id="object-builder-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="obj-builder-preview" style="display:flex;justify-content:center;padding:12px 0;margin-bottom:8px;background:var(--surface);border-radius:8px;border:1px solid var(--border)">
                    <img id="obj-builder-preview-img" style="width:128px;height:128px;border-radius:6px;image-rendering:auto;">
                </div>
                <div class="settings-row">
                    <label>Name</label>
                    <input type="text" id="obj-builder-name" class="prop-input" value="My Object">
                </div>
                <div id="obj-builder-parts" style="margin-top:12px"></div>
                <button class="action-btn" id="obj-builder-add-part" style="margin-top:8px">
                    <span class="material-icons-round">add</span> Add Part
                </button>
            </div>
            <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;padding:16px 24px;border-top:1px solid var(--border)">
                <button class="action-btn" id="obj-builder-cancel">Cancel</button>
                <button class="action-btn primary" id="obj-builder-save">Save Object</button>
            </div>
        </div>
    </div>

    <!-- Screen Editor Modal -->
    <div id="screen-editor-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:700px">
            <div class="modal-header">
                <span class="material-icons-round">web</span>
                <span>UI Screen Editor</span>
                <button class="modal-close" id="screen-editor-close"><span class="material-icons-round">close</span></button>
            </div>
            <div class="modal-body" style="padding:0">
                <div style="padding:12px 24px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                    <label style="font-size:13px;font-weight:600">Name</label>
                    <input type="text" id="screen-editor-name" class="prop-input" style="flex:1;min-width:120px" value="My Screen">
                    <label style="font-size:13px;font-weight:600">BG</label>
                    <input type="color" id="screen-editor-bg" value="#000000" style="width:36px;height:24px;border:1px solid var(--border);border-radius:4px;cursor:pointer;background:none;padding:1px">
                    <label style="font-size:13px;font-weight:600">Opacity</label>
                    <input type="range" id="screen-editor-bg-opacity" min="0" max="100" value="80" style="width:60px;accent-color:var(--accent)">
                    <label style="font-size:13px;display:flex;align-items:center;gap:4px;cursor:pointer;user-select:none">
                        <input type="checkbox" id="screen-editor-no-bg" style="accent-color:var(--accent)"> No BG
                    </label>
                </div>
                <div id="screen-editor-preview" style="position:relative;width:100%;aspect-ratio:16/9;overflow:hidden;border-bottom:1px solid var(--border)">
                </div>
                <div style="padding:12px 24px;max-height:250px;overflow-y:auto">
                    <div style="display:flex;gap:8px;margin-bottom:12px">
                        <button class="action-btn" id="screen-add-text">
                            <span class="material-icons-round">title</span> Text
                        </button>
                        <button class="action-btn" id="screen-add-button">
                            <span class="material-icons-round">smart_button</span> Button
                        </button>
                        <button class="action-btn" id="screen-add-panel">
                            <span class="material-icons-round">rectangle</span> Panel
                        </button>
                    </div>
                    <div id="screen-elements-list"></div>
                </div>
            </div>
            <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;padding:16px 24px;border-top:1px solid var(--border)">
                <button class="action-btn" id="screen-editor-delete" style="margin-right:auto;color:#e74c3c">
                    <span class="material-icons-round">delete</span> Delete Screen
                </button>
                <button class="action-btn" id="screen-editor-cancel">Cancel</button>
                <button class="action-btn primary" id="screen-editor-save">Save Screen</button>
            </div>
        </div>
    </div>

    <!-- Collab Modal -->
    <div id="collab-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:420px">
            <div class="modal-header">
                <span class="material-icons-round">group</span>
                <span>Multiplayer Party</span>
                <button class="modal-close" id="collab-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Create/Join section (shown when not in a room) -->
                <div id="collab-join-section">
                    <p style="color:var(--text-dim);font-size:12px;margin-bottom:16px">Build together in real time. Create a room and share the code, or join an existing room.</p>
                    <button class="action-btn primary" id="collab-create-btn" style="width:100%;justify-content:center;padding:10px;font-size:14px;margin-bottom:16px">
                        <span class="material-icons-round">add_circle</span> Create Room
                    </button>
                    <div class="collab-divider"><span>or join a room</span></div>
                    <div class="collab-join-row">
                        <input type="text" id="collab-code-input" class="collab-code-input" placeholder="ROOM CODE" maxlength="6" spellcheck="false" autocomplete="off">
                        <button class="action-btn primary" id="collab-join-btn">Join</button>
                    </div>
                </div>
                <!-- Active room section (shown when in a room) -->
                <div id="collab-active-section" class="hidden">
                    <div class="collab-room-info">
                        <div class="collab-room-code-label">Room Code</div>
                        <div class="collab-room-code" id="collab-room-code"></div>
                        <div class="collab-role-badge" id="collab-role-badge">HOST</div>
                    </div>
                    <div class="collab-member-list" id="collab-member-list">
                        <!-- Populated dynamically -->
                    </div>
                    <button class="action-btn collab-leave-btn" id="collab-leave-btn">
                        <span class="material-icons-round">logout</span> Leave Room
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Panel -->
    <div id="ai-panel" class="ai-panel hidden">
        <div class="ai-panel-header">
            <span class="material-icons-round ai-panel-icon">auto_awesome</span>
            <span class="ai-panel-title">AI Build Assistant</span>
            <button class="ai-panel-close" id="ai-panel-close">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="ai-panel-messages" id="ai-messages">
            <div class="ai-message ai-system">
                <span class="material-icons-round">auto_awesome</span>
                <span>Describe what you want to build and I'll place it in your scene!</span>
            </div>
        </div>
        <div class="ai-panel-input">
            <input type="text" id="ai-prompt-input" placeholder="Build a castle with towers..." maxlength="500" autocomplete="off" spellcheck="false">
            <button class="ai-build-btn" id="ai-build-btn" title="Generate">
                <span class="material-icons-round">arrow_upward</span>
            </button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:400px">
            <div class="modal-header">
                <span class="material-icons-round" id="confirm-modal-icon">warning</span>
                <span id="confirm-modal-title">Confirm</span>
                <button class="modal-close" id="confirm-modal-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message" style="font-size:14px;line-height:1.6"></p>
                <div id="confirm-modal-input-wrap" class="hidden" style="margin-top:12px">
                    <input type="text" id="confirm-modal-input" class="prop-input" style="width:100%;padding:8px 12px;font-size:14px">
                </div>
            </div>
            <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;padding:16px 20px;border-top:1px solid var(--border)">
                <button class="action-btn" id="confirm-modal-cancel">Cancel</button>
                <button class="action-btn" id="confirm-modal-confirm">OK</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:480px">
            <div class="modal-header">
                <span class="material-icons-round">keyboard</span>
                <span>Keyboard Shortcuts</span>
                <button class="modal-close" id="shortcuts-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" id="shortcuts-body">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width:380px">
            <div class="modal-header">
                <span class="material-icons-round">info</span>
                <span>About</span>
                <button class="modal-close" id="about-close">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" style="text-align:center;padding:32px 24px">
                <span class="about-logo-icon"><svg viewBox="0 0 64 64" fill="none"><path d="M33 30L21 9L32 2L58 17L58 30Z" fill="#93c5fd"/><path d="M33 30L58 17L58 30Z" fill="#4338ca"/><path d="M34 34L58 34L58 47L32 62Z" fill="#4338ca"/><path d="M34 34L20 56L32 62Z" fill="#6366f1"/><path d="M30 32L17 11L6 17Z" fill="#93c5fd"/><path d="M30 32L6 17L6 47L17 55Z" fill="#6366f1"/></svg></span>
                <div style="font-weight:700;font-size:18px;margin:12px 0 4px;background:linear-gradient(135deg,#4c97ff,#9966ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Cobalt Studio</div>
                <div id="about-version" style="font-size:12px;color:var(--text-dim);margin-bottom:16px"></div>
                <p style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:12px">
                    Build 3D games with blocks. Drag and drop objects, write visual block code, and share your creations.
                </p>
                <p style="font-size:11px;color:var(--text-dim)">
                    Press <kbd>?</kbd> for keyboard shortcuts
                </p>
            </div>
        </div>
    </div>

    <!-- Publish Modal -->
    <div id="publish-modal" class="hidden">
        <div class="publish-dialog">
            <div class="publish-dialog-header">
                <span class="material-icons-round">publish</span>
                <h3>Publish Project</h3>
            </div>
            <div class="publish-dialog-body">
                <div class="publish-field">
                    <label for="publish-title">Title</label>
                    <input type="text" id="publish-title" placeholder="Project title" maxlength="60" spellcheck="false">
                </div>
                <div class="publish-field">
                    <label for="publish-description">Description</label>
                    <textarea id="publish-description" placeholder="Describe your project..." maxlength="200" rows="3"></textarea>
                </div>
                <div class="publish-field">
                    <label>Tags</label>
                    <div class="publish-tags">
                        <label class="publish-tag-checkbox"><input type="checkbox" value="Games"> Games</label>
                        <label class="publish-tag-checkbox"><input type="checkbox" value="Art"> Art</label>
                        <label class="publish-tag-checkbox"><input type="checkbox" value="Platformer"> Platformer</label>
                        <label class="publish-tag-checkbox"><input type="checkbox" value="Adventure"> Adventure</label>
                        <label class="publish-tag-checkbox"><input type="checkbox" value="Puzzle"> Puzzle</label>
                    </div>
                </div>
                <div class="publish-share-link" id="publish-share-link">
                    <label>Share Link</label>
                    <div class="publish-link-row">
                        <input type="text" id="publish-link-input" readonly>
                        <button type="button" id="publish-copy-link">Copy</button>
                    </div>
                </div>
            </div>
            <div class="publish-dialog-footer">
                <button class="publish-cancel-btn" id="publish-cancel">Cancel</button>
                <button class="publish-unpublish-btn hidden" id="publish-unpublish">Unpublish</button>
                <button class="publish-submit-btn" id="publish-submit">Publish</button>
            </div>
        </div>
    </div>

    <!-- Avatar Upload Modal -->
    <div id="avatar-modal" class="modal-overlay hidden">
        <div class="modal-dialog" style="max-width:400px">
            <div class="modal-header">
                <span class="material-icons-round">account_circle</span>
                <span>Profile Picture</span>
                <button class="modal-close" id="avatar-modal-close"><span class="material-icons-round">close</span></button>
            </div>
            <div class="modal-body" style="padding:24px;display:flex;flex-direction:column;align-items:center;gap:16px">
                <div id="avatar-preview" class="avatar-upload-preview"></div>
                <input type="file" id="avatar-file-input" accept="image/*" style="display:none">
                <button class="action-btn primary" id="avatar-upload-btn" style="gap:6px"><span class="material-icons-round" style="font-size:18px">upload</span> Upload Image</button>
                <button class="action-btn" id="avatar-remove-btn" style="font-size:12px;display:none">Remove &amp; use default</button>
                <div id="avatar-upload-hint" style="font-size:11px;color:var(--text-dim);text-align:center">Square images work best. Max 500KB.</div>
            </div>
        </div>
    </div>

    <!-- Project Page (Scratch-style) -->
    <div id="project-page" class="hidden">
        <div class="pp-header">
            <button class="pp-back-btn" id="pp-back">
                <span class="material-icons-round">arrow_back</span>
                <span>Back to Explore</span>
            </button>
            <div class="pp-header-info">
                <span class="pp-title" id="pp-title"></span>
                <span class="pp-creator" id="pp-creator"></span>
            </div>
        </div>
        <div class="pp-body">
            <div class="pp-main">
                <div class="pp-viewport-wrapper">
                    <div class="pp-viewport" id="pp-viewport-container">
                        <canvas id="pp-canvas"></canvas>
                        <!-- Exit fullscreen button (inside viewport so visible in fullscreen) -->
                        <button class="pp-exit-fullscreen hidden" id="pp-exit-fullscreen" title="Exit Fullscreen">
                            <span class="material-icons-round">fullscreen_exit</span>
                        </button>
                        <!-- Play overlay for viewer -->
                        <div id="pp-play-overlay" class="hidden">
                            <div class="play-hud">
                                <div class="play-info">
                                    <span>WASD to move | Arrows to look | Space to jump | ESC to stop</span>
                                </div>
                                <div class="game-hud" id="pp-game-hud"></div>
                            </div>
                        </div>
                        <!-- Crosshair for viewer -->
                        <div id="pp-crosshair" class="hidden">
                            <svg width="24" height="24" viewBox="0 0 24 24">
                                <line x1="12" y1="4" x2="12" y2="10" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                <line x1="12" y1="14" x2="12" y2="20" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                <line x1="4" y1="12" x2="10" y2="12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                <line x1="14" y1="12" x2="20" y2="12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="2" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
                            </svg>
                        </div>
                    </div>
                    <div class="pp-controls">
                        <button class="pp-flag-btn" id="pp-btn-play" title="Green Flag - Start">
                            <svg viewBox="0 0 24 24" width="22" height="22"><path d="M5 3v18" stroke="#45a049" stroke-width="2.5" stroke-linecap="round"/><path d="M5 3l14 6-14 6z" fill="#4CAF50"/></svg>
                        </button>
                        <button class="pp-stop-btn" id="pp-btn-stop" title="Stop">
                            <svg viewBox="0 0 24 24" width="22" height="22"><polygon points="7.2,2 16.8,2 22,7.2 22,16.8 16.8,22 7.2,22 2,16.8 2,7.2" fill="#e53935"/></svg>
                        </button>
                        <div class="pp-controls-spacer"></div>
                        <button class="pp-ctrl-btn" id="pp-btn-fullscreen" title="Fullscreen">
                            <span class="material-icons-round">fullscreen</span>
                        </button>
                    </div>
                </div>
                <div class="pp-emoji-chat" id="pp-emoji-chat">
                    <h4>Chat</h4>
                    <div class="pp-emoji-picker" id="pp-emoji-picker"></div>
                    <div class="pp-emoji-feed" id="pp-emoji-feed"></div>
                </div>
            </div>
            <div class="pp-sidebar">
                <div class="pp-desc-section">
                    <h4>Description</h4>
                    <p id="pp-description" class="pp-desc-text">No description provided.</p>
                </div>
                <div class="pp-tags-section" id="pp-tags-section">
                    <div class="pp-tags" id="pp-tags"></div>
                </div>
                <div class="pp-creator-card">
                    <div class="pp-creator-avatar" id="pp-creator-avatar"></div>
                    <div class="pp-creator-info">
                        <span class="pp-creator-name" id="pp-creator-name"></span>
                        <span class="pp-creator-label">Creator</span>
                    </div>
                </div>
                <div class="pp-actions-row">
                    <button class="pp-like-btn" id="pp-like-btn" title="Like">
                        <span class="material-icons-round">favorite_border</span>
                        <span class="pp-action-count" id="pp-like-count">0</span>
                    </button>
                    <button class="pp-fav-btn" id="pp-fav-btn" title="Favorite">
                        <span class="material-icons-round">star_border</span>
                        <span class="pp-action-count" id="pp-fav-count">0</span>
                    </button>
                </div>
                <div class="pp-views-row" id="pp-views-row">
                    <span class="material-icons-round">visibility</span>
                    <span id="pp-view-count">0</span> views
                </div>
                <button class="pp-remix-btn" id="pp-remix-btn">
                    <span class="material-icons-round">content_copy</span>
                    Remix
                </button>
                <button class="pp-report-btn" id="pp-report-btn">
                    <span class="material-icons-round">flag</span>
                    Report
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile-page" class="hidden">
        <div class="prof-header">
            <button class="prof-back-btn" id="prof-back">
                <span class="material-icons-round">arrow_back</span>
                <span>Back</span>
            </button>
        </div>
        <div class="prof-body">
            <div class="prof-banner">
                <div class="prof-avatar-large" id="prof-avatar"></div>
                <div class="prof-user-info">
                    <div class="prof-display-name" id="prof-display-name"></div>
                    <div class="prof-username" id="prof-username"></div>
                    <div class="prof-member-since" id="prof-member-since"></div>
                </div>
                <div class="prof-stats">
                    <div class="prof-stat">
                        <span class="prof-stat-value" id="prof-project-count">0</span>
                        <span class="prof-stat-label">Shared Projects</span>
                    </div>
                </div>
            </div>
            <h3 class="prof-section-title">Shared Projects</h3>
            <div class="prof-project-grid" id="prof-project-grid"></div>
            <div class="prof-empty hidden" id="prof-empty">
                <span class="material-icons-round">inventory_2</span>
                <p>No shared projects yet</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/three.min.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/TransformControls.js"></script>
    <script src="js/scene3d.js"></script>
    <script src="js/blockcode.js?v=3"></script>
    <script src="js/runtime.js"></script>
    <script src="js/guided-tutorial.js"></script>
    <script src="js/textures.js"></script>
    <script src="js/app.js?v=3"></script>
</body>
</html>
